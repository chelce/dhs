<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Calendar & Reflections</title>
    <!-- Harmony OS Font -->
    <link href="https://fonts.googleapis.com/css2?family=HarmonyOS+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- TipTap Editor Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@tiptap/core@2.1.13/dist/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2.1.13/dist/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tiptap/extension-placeholder@2.1.13/dist/index.umd.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'HarmonyOS Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .calendar-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .month-year {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .class-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e0e0e0;
        }
        
        .week-row {
            display: contents;
        }
        
        .week-label {
            grid-column: 1 / -1;
            background: #34495e;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid #2c3e50;
        }
        
        .week-label.current-week {
            background: #3498db;
            border-bottom-color: #2980b9;
        }
        
        .day-header {
            background: #34495e;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .day-cell {
            background: white;
            min-height: 100px;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        
        .day-cell.current-week {
            background: #f8f9fa;
            border-left: 3px solid #3498db;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .day-cell.other-month .day-number {
            color: #bdc3c7;
        }
        
        .day-cell.today {
            background: #ecf0f1;
            border: 2px solid #e74c3c;
        }
        
        .day-cell.today.current-week {
            background: #d5dbdb;
            border: 2px solid #e74c3c;
        }
        
        .week-range {
            text-align: center;
            color: white;
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .event {
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 2px;
            color: white;
            font-weight: 500;
        }
        
        .reflection {
            background: #95a5a6;
            border-left: 3px solid #7f8c8d;
        }
        
        .tentative {
            opacity: 0.7;
            font-style: italic;
        }
        
        /* Class colors */
        .class-2a { background: #9b59b6; }
        .class-2b { background: #3498db; }
        .class-3b { background: #27ae60; }
        .class-ap { background: #e67e22; }
        .class-4b { background: #e91e63; }
        
        .upcoming-section {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .upcoming-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .upcoming-list {
            list-style: none;
            padding: 0;
        }
        
        .upcoming-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Interactive features */
        .day-cell:hover {
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .day-cell.today:hover {
            background: #d5dbdb;
        }
        
        .event {
            position: relative;
            cursor: pointer;
        }
        
        .event:hover {
            opacity: 0.8;
        }
        
        .event .delete-btn {
            position: absolute;
            right: 2px;
            top: 1px;
            background: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: none;
            color: #e74c3c;
        }
        
        .event:hover .delete-btn {
            display: block;
        }
        
        .controls {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .month-nav button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .month-nav button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .export-section {
            margin-left: auto;
        }
        
        /* TipTap Editor Styles */
        .tiptap-editor {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }
        
        .tiptap-editor:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .tiptap-editor p {
            margin: 0 0 8px 0;
        }
        
        .tiptap-editor h3 {
            margin: 12px 0 6px 0;
            font-size: 16px;
        }
        
        .tiptap-editor ul, .tiptap-editor ol {
            padding-left: 20px;
            margin: 8px 0;
        }
        
        .tiptap-editor strong {
            font-weight: 600;
        }
        
        /* Event Details Modal */
        .event-details-modal .modal-content {
            max-width: 800px;
        }
        
        .event-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .event-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .event-class-badge {
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .notes-section {
            margin-top: 20px;
        }
        
        .notes-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: block;
        }
        
        .event-meta {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="controls">
            <div class="controls-row">
                <div class="filter-group">
                    <strong>Show Classes:</strong>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-2a" checked>
                        <label for="show-2a">2A</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-2b" checked>
                        <label for="show-2b">2B</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-3b" checked>
                        <label for="show-3b">3B</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-ap" checked>
                        <label for="show-ap">AP</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-4b" checked>
                        <label for="show-4b">4B</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-reflection" checked>
                        <label for="show-reflection">Reflections</label>
                    </div>
                </div>
                <div class="export-section">
                    <button class="btn btn-primary" onclick="exportCalendar()">Export Calendar</button>
                    <button class="btn btn-secondary" onclick="importCalendar()">Import</button>
                </div>
            </div>
        </div>
        
        <div class="calendar-header">
            <div class="month-nav">
                <button onclick="changeWeek(-1)">← Previous Week</button>
                <div class="month-year" id="monthYear">7-Week Teaching View</div>
                <button onclick="changeWeek(1)">Next Week →</button>
            </div>
            <div class="week-range" id="weekRange"></div>
            <div class="class-legend">
                <div class="legend-item">
                    <div class="color-box class-2a"></div>
                    <span>2A (Purple)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box class-2b"></div>
                    <span>2B (Blue)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box class-3b"></div>
                    <span>3B (Green)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box class-ap"></div>
                    <span>AP (Orange)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box class-4b"></div>
                    <span>4B (Hot Pink)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box reflection"></div>
                    <span>Reflection</span>
                </div>
            </div>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
            <!-- Dynamic weekly calendar will be generated here -->
        </div>
        
        <div class="upcoming-section">
            <div class="upcoming-title">Upcoming Items</div>
            <ul class="upcoming-list">
                <li class="upcoming-item class-2a">
                    <span>2A: Continue analogies work</span>
                    <span>Next class</span>
                </li>
                <li class="upcoming-item class-ap">
                    <span>AP: Profile targeting exercise</span>
                    <span>Next class</span>
                </li>
                <li class="upcoming-item class-4b">
                    <span>4B: More analogies/additional activity needed</span>
                    <span>Next class</span>
                </li>
                <li class="upcoming-item class-ap tentative">
                    <span>AP: Vocab #1 + Intellectual Devotional Week 9 Quiz</span>
                    <span>Week 3 (Tentative)</span>
                </li>
                <li class="upcoming-item reflection">
                    <span>Create AP vocab list</span>
                    <span>This week</span>
                </li>
                <li class="upcoming-item reflection">
                    <span>Prepare more analogies content</span>
                    <span>Before next 4B class</span>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Add Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add Event</span>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="eventForm">
                <div class="form-group">
                    <label for="eventText">Event Text:</label>
                    <input type="text" id="eventText" placeholder="Enter event title..." required>
                </div>
                <div class="form-group">
                    <label for="eventNotes">Reflection Notes:</label>
                    <div id="eventNotesEditor" class="tiptap-editor"></div>
                    <input type="hidden" id="eventNotes">
                </div>
                <div class="form-group">
                    <label for="eventClass">Class/Type:</label>
                    <select id="eventClass" required>
                        <option value="">Select class...</option>
                        <option value="2a">2A (Purple)</option>
                        <option value="2b">2B (Blue)</option>
                        <option value="3b">3B (Green)</option>
                        <option value="ap">AP (Orange)</option>
                        <option value="4b">4B (Hot Pink)</option>
                        <option value="reflection">Reflection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="eventType">Event Type:</label>
                    <select id="eventType">
                        <option value="">Regular</option>
                        <option value="tentative">Tentative</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Event</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="modal event-details-modal">
        <div class="modal-content">
            <div class="event-details-header">
                <div>
                    <div class="event-title" id="eventDetailsTitle"></div>
                    <div class="event-meta" id="eventDetailsMeta"></div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="event-class-badge" id="eventDetailsClassBadge"></span>
                    <span class="close" onclick="closeEventDetailsModal()">&times;</span>
                </div>
            </div>
            <div class="notes-section">
                <label class="notes-label">Reflection Notes:</label>
                <div id="eventDetailsNotes" class="tiptap-editor"></div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="editEvent()">Edit Event</button>
                <button type="button" class="btn btn-secondary" onclick="closeEventDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://dfqjhgftmhdsjlcdaaxk.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmcWpoZ2Z0bWhkc2psY2RhYXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MDY0NTEsImV4cCI6MjA2NjM4MjQ1MX0.iu1OH2wV6hjV9EhxkFBwqSApcy6uRn0b40AOc9yJ0Yk'
        
        let supabase = null;
        let notesEditor = null;
        let detailsEditor = null;
        let currentEvent = null;
        
        // Initialize Supabase (will be set up after you create the project)
        function initSupabase() {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        }
        
        // Calendar data and state
        let currentWeekOffset = 0; // 0 = current week, -1 = prev week, +1 = next week
        let selectedDay = null;
        
        // Month names
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
        
        // Day names
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        // Get current date and week boundaries
        function getCurrentWeekBounds() {
            const today = new Date();
            const currentDayOfWeek = today.getDay(); // 0 = Sunday
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - currentDayOfWeek + (currentWeekOffset * 7));
            
            return startOfWeek;
        }
        
        // Generate 7 weeks of dates (3 before, current, 3 after)
        function generateWeeks() {
            const weeks = [];
            const baseWeekStart = getCurrentWeekBounds();
            
            // Go back 3 weeks from the base week
            for (let weekOffset = -3; weekOffset <= 3; weekOffset++) {
                const weekStart = new Date(baseWeekStart);
                weekStart.setDate(baseWeekStart.getDate() + (weekOffset * 7));
                
                const week = [];
                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + dayOffset);
                    week.push({
                        date: date,
                        isCurrentWeek: weekOffset === 0,
                        isToday: date.toDateString() === new Date().toDateString()
                    });
                }
                weeks.push(week);
            }
            
            return weeks;
        }
        
        // Initialize calendar on load
        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
            initTipTapEditors();
            generateCalendar();
            loadCalendarData();
            setupFilterListeners();
        });
        
        // Initialize TipTap editors
        function initTipTapEditors() {
            // Editor for adding/editing events
            notesEditor = new window.Tiptap.Editor({
                element: document.getElementById('eventNotesEditor'),
                extensions: [
                    window.TiptapStarterKit.StarterKit,
                    window.TiptapPlaceholder.Placeholder.configure({
                        placeholder: 'Add reflection notes about this lesson/activity...'
                    })
                ],
                content: '',
                onUpdate: ({ editor }) => {
                    document.getElementById('eventNotes').value = editor.getHTML();
                }
            });
            
            // Read-only editor for viewing event details
            detailsEditor = new window.Tiptap.Editor({
                element: document.getElementById('eventDetailsNotes'),
                extensions: [window.TiptapStarterKit.StarterKit],
                editable: false,
                content: ''
            });
        }
        
        // Generate the 7-week calendar dynamically
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(dayName => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = dayName.substring(0, 3);
                calendarGrid.appendChild(header);
            });
            
            // Generate weeks
            const weeks = generateWeeks();
            weeks.forEach((week, weekIndex) => {
                // Add week label
                const weekLabel = document.createElement('div');
                weekLabel.className = 'week-label';
                if (week[0].isCurrentWeek) {
                    weekLabel.classList.add('current-week');
                }
                
                const weekStart = week[0].date;
                const weekEnd = week[6].date;
                const startStr = `${weekStart.getMonth() + 1}/${weekStart.getDate()}`;
                const endStr = `${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`;
                
                if (week[0].isCurrentWeek) {
                    weekLabel.textContent = `Current Week: ${startStr} - ${endStr}`;
                } else {
                    weekLabel.textContent = `${startStr} - ${endStr}`;
                }
                
                calendarGrid.appendChild(weekLabel);
                
                // Add days for this week
                week.forEach(dayInfo => {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    if (dayInfo.isCurrentWeek) {
                        dayCell.classList.add('current-week');
                    }
                    
                    if (dayInfo.isToday) {
                        dayCell.classList.add('today');
                    }
                    
                    // Add click handler
                    dayCell.onclick = () => addEvent(dayInfo.date);
                    
                    // Add day number
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = dayInfo.date.getDate();
                    dayCell.appendChild(dayNumber);
                    
                    // Add hardcoded events for specific dates
                    addHardcodedEvents(dayCell, dayInfo.date);
                    
                    calendarGrid.appendChild(dayCell);
                });
            });
            
            // Update week range display
            updateWeekRangeDisplay();
        }
        
        // Add hardcoded historical events
        function addHardcodedEvents(dayCell, date) {
            const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            
            // August 23, 2025 events
            if (dateStr === '2025-08-23') {
                addEventElement(dayCell, 'Logic Puzzle Opening Activity', '2a', false, true, 
                    '<h3>What Worked Well:</h3><p>• Scattergories was a huge success</p><p>• Students engaged well with logic puzzles</p><h3>Notes for Next Time:</h3><p>• Baker\'s problem needs more scaffolding</p>');
                addEventElement(dayCell, "Baker's Problem Activity", '2a', false, true,
                    '<h3>Activity Notes:</h3><p>• Problem was challenging for students</p><p>• Need to provide more guidance next time</p><p>• Consider breaking into smaller steps</p>');
            }
            
            // August 28, 2025 events  
            if (dateStr === '2025-08-28') {
                addEventElement(dayCell, 'Analogies Introduction', 'ap', false, true,
                    '<h3>AP Class - Analogies Lesson:</h3><p>• Introduced analogy concepts</p><p>• Students seemed to grasp the basics</p><p>• Need more practice examples</p>');
                addEventElement(dayCell, 'Analogies Introduction', '2a', false, true,
                    '<h3>2A Class - Analogies Lesson:</h3><p>• Same content as AP but adapted pace</p><p>• Students needed more explanation</p><p>• Consider visual aids next time</p>');
            }
            
            // August 29, 2025 events
            if (dateStr === '2025-08-29') {
                addEventElement(dayCell, 'ABC Game + Analogies', '2a', false, true,
                    '<h3>2A Today:</h3><p>• ABC game for kitchen items + things smaller than golf ball</p><p>• Started analogies (5 minutes only)</p><p>• Good pacing, will continue analogies next class</p>');
                    
                addEventElement(dayCell, 'Rhetorical Situation Lesson', 'ap', false, true,
                    '<h3>AP Today:</h3><p>• Covered rhetorical triangle (SPACE[cat])</p><p>• In/out group, demographics, psychographics</p><p>• Self-profiling exercise went well</p><p>• Students work more efficiently than expected - felt scrambling</p><p>• Depth uncertain, need to assess better</p><p><strong>Next:</strong> Profile targeting exercise</p>');
                    
                addEventElement(dayCell, 'ABC Game + Analogies', '4b', false, true,
                    '<h3>4B Today:</h3><p>• ABC game (kitchen items only) - took unexpectedly long</p><p>• Got through many analogies but 1/3 of class needs more content</p><p><strong>Next:</strong> Need more analogies or additional activity for faster finishers</p>');
                    
                addEventElement(dayCell, 'Hearts & Dollars Launch', 'reflection', false, true,
                    '<h3>System Launch:</h3><p>• Introduced hearts & dollars system today</p><p>• Started paying students in 2A and 4B</p><p>• B day students all paid up</p><p>• NFC key integration postponed</p><p><strong>Issue:</strong> Need better group adherence enforcement - consider heart penalty</p>');
            }
        }
        
        // Helper function to create event elements
        function addEventElement(parentCell, text, eventClass, isTentative = false, isHardcoded = false, notes = '') {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event class-${eventClass}`;
            eventDiv.setAttribute('data-class', eventClass);
            eventDiv.setAttribute('data-notes', notes || '');
            
            if (isTentative) {
                eventDiv.classList.add('tentative');
            }
            
            if (isHardcoded) {
                eventDiv.setAttribute('data-hardcoded', 'true');
            }
            
            // Add click handler to show details
            eventDiv.addEventListener('click', (e) => {
                if (!e.target.classList.contains('delete-btn')) {
                    showEventDetails(eventDiv, text, eventClass, notes);
                }
            });
            
            eventDiv.innerHTML = `
                ${text}
                <button class="delete-btn" onclick="deleteEvent(this)">&times;</button>
            `;
            
            parentCell.appendChild(eventDiv);
        }
        
        // Show event details modal
        function showEventDetails(eventElement, title, eventClass, notes) {
            currentEvent = eventElement;
            
            // Set title and class badge
            document.getElementById('eventDetailsTitle').textContent = title;
            document.getElementById('eventDetailsMeta').textContent = `Class: ${getClassDisplayName(eventClass)}`;
            
            // Set class badge color and text
            const badge = document.getElementById('eventDetailsClassBadge');
            badge.textContent = getClassDisplayName(eventClass);
            badge.className = `event-class-badge class-${eventClass}`;
            
            // Load notes into editor
            detailsEditor.commands.setContent(notes || '<p>No reflection notes yet.</p>');
            
            // Show modal
            document.getElementById('eventDetailsModal').style.display = 'block';
        }
        
        // Helper function to get display name for class
        function getClassDisplayName(eventClass) {
            const classNames = {
                '2a': '2A (Purple)',
                '2b': '2B (Blue)', 
                '3b': '3B (Green)',
                'ap': 'AP (Orange)',
                '4b': '4B (Hot Pink)',
                'reflection': 'Reflection'
            };
            return classNames[eventClass] || eventClass;
        }
        
        // Close event details modal
        function closeEventDetailsModal() {
            document.getElementById('eventDetailsModal').style.display = 'none';
            currentEvent = null;
        }
        
        // Edit current event
        function editEvent() {
            if (currentEvent) {
                const title = document.getElementById('eventDetailsTitle').textContent;
                const eventClass = currentEvent.getAttribute('data-class');
                const notes = currentEvent.getAttribute('data-notes');
                
                // Populate edit form
                document.getElementById('eventText').value = title;
                document.getElementById('eventClass').value = eventClass;
                notesEditor.commands.setContent(notes || '');
                
                // Close details modal and open edit modal
                closeEventDetailsModal();
                document.getElementById('eventModal').style.display = 'block';
            }
        }
        
        // Update week range display
        function updateWeekRangeDisplay() {
            const weeks = generateWeeks();
            const firstWeek = weeks[0];
            const lastWeek = weeks[6];
            
            const startDate = firstWeek[0].date;
            const endDate = lastWeek[6].date;
            
            const startStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            document.getElementById('weekRange').textContent = `${startStr} - ${endStr}`;
        }
        
        // Event handling functions
        function addEvent(date) {
            selectedDay = date;
            document.getElementById('eventModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
            document.getElementById('eventForm').reset();
            if (notesEditor) {
                notesEditor.commands.clearContent();
                document.getElementById('eventNotes').value = '';
            }
        }
        
        function deleteEvent(button) {
            event.stopPropagation();
            if (confirm('Delete this event?')) {
                button.parentElement.remove();
                saveCalendarData();
            }
        }
        
        // Week navigation
        function changeWeek(direction) {
            currentWeekOffset += direction;
            generateCalendar();
            loadCalendarData();
        }
        
        function updateCalendarDisplay() {
            generateCalendar();
        }
        
        // Form submission
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const eventText = document.getElementById('eventText').value;
            const eventClass = document.getElementById('eventClass').value;
            const eventType = document.getElementById('eventType').value;
            const eventNotes = document.getElementById('eventNotes').value;
            
            // Find the day cell for the selected date
            const dayCells = document.querySelectorAll('.day-cell');
            let targetCell = null;
            
            dayCells.forEach(cell => {
                const dayNumber = parseInt(cell.querySelector('.day-number').textContent);
                if (selectedDay instanceof Date) {
                    if (dayNumber === selectedDay.getDate()) {
                        targetCell = cell;
                    }
                } else if (dayNumber === selectedDay) {
                    targetCell = cell;
                }
            });
            
            if (targetCell) {
                addEventElement(targetCell, eventText, eventClass, eventType === 'tentative', false, eventNotes);
                saveCalendarData();
            }
            
            closeModal();
        });
        
        // Data persistence with Supabase
        async function saveCalendarData() {
            if (!supabase) {
                saveToLocalStorage();
                return;
            }
            
            try {
                // Get the current date range
                const weeks = generateWeeks();
                const startDate = weeks[0][0].date;
                const endDate = weeks[6][6].date;
                
                // Clear existing events for this date range
                await supabase
                    .from('calendar_events')
                    .delete()
                    .gte('event_date', startDate.toISOString().split('T')[0])
                    .lte('event_date', endDate.toISOString().split('T')[0]);
                
                // Collect all current events
                const eventsToSave = [];
                document.querySelectorAll('.day-cell').forEach(cell => {
                    const dayNumber = parseInt(cell.querySelector('.day-number').textContent);
                    
                    cell.querySelectorAll('.event').forEach(event => {
                        if (!event.hasAttribute('data-hardcoded')) {
                            const text = event.textContent.replace('×', '').trim();
                            const className = event.getAttribute('data-class');
                            const isTentative = event.classList.contains('tentative');
                            const notes = event.getAttribute('data-notes') || '';
                            
                            // Find the corresponding date
                            weeks.forEach(week => {
                                week.forEach(day => {
                                    if (day.date.getDate() === dayNumber) {
                                        eventsToSave.push({
                                            event_date: day.date.toISOString().split('T')[0],
                                            year: day.date.getFullYear(),
                                            month: day.date.getMonth(),
                                            day: day.date.getDate(),
                                            event_text: text,
                                            event_class: className,
                                            is_tentative: isTentative,
                                            notes: notes,
                                            created_at: new Date().toISOString()
                                        });
                                    }
                                });
                            });
                        }
                    });
                });
                
                // Insert new events
                if (eventsToSave.length > 0) {
                    const { error } = await supabase
                        .from('calendar_events')
                        .insert(eventsToSave);
                    
                    if (error) throw error;
                }
                
                console.log('Calendar saved to Supabase successfully');
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                saveToLocalStorage();
            }
        }
        
        async function loadCalendarData() {
            if (!supabase) {
                loadFromLocalStorage();
                return;
            }
            
            try {
                // Get the current date range
                const weeks = generateWeeks();
                const startDate = weeks[0][0].date;
                const endDate = weeks[6][6].date;
                
                const { data, error } = await supabase
                    .from('calendar_events')
                    .select('*')
                    .gte('event_date', startDate.toISOString().split('T')[0])
                    .lte('event_date', endDate.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                // Clear existing non-hardcoded events
                document.querySelectorAll('.event').forEach(event => {
                    if (!event.hasAttribute('data-hardcoded')) {
                        event.remove();
                    }
                });
                
                // Add events from database
                data.forEach(eventData => {
                    const eventDate = new Date(eventData.event_date + 'T00:00:00');
                    const dayNumber = eventDate.getDate();
                    
                    // Find the corresponding day cell
                    const dayCells = document.querySelectorAll('.day-cell');
                    dayCells.forEach(cell => {
                        const cellDayNumber = parseInt(cell.querySelector('.day-number').textContent);
                        if (cellDayNumber === dayNumber) {
                            addEventElement(cell, eventData.event_text, eventData.event_class, eventData.is_tentative, false, eventData.notes || '');
                        }
                    });
                });
                
                console.log('Calendar loaded from Supabase successfully');
            } catch (error) {
                console.error('Error loading from Supabase:', error);
                loadFromLocalStorage();
            }
        }
        
        // Filter functionality
        function setupFilterListeners() {
            const checkboxes = document.querySelectorAll('.filter-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateEventVisibility);
            });
        }
        
        function updateEventVisibility() {
            const checkboxes = {
                '2a': document.getElementById('show-2a').checked,
                '2b': document.getElementById('show-2b').checked,
                '3b': document.getElementById('show-3b').checked,
                'ap': document.getElementById('show-ap').checked,
                '4b': document.getElementById('show-4b').checked,
                'reflection': document.getElementById('show-reflection').checked
            };
            
            document.querySelectorAll('.event').forEach(event => {
                const eventClass = event.getAttribute('data-class');
                if (checkboxes[eventClass] !== undefined) {
                    event.style.display = checkboxes[eventClass] ? 'block' : 'none';
                }
            });
        }
        
        // Data persistence with Supabase
        async function saveCalendarData() {
            if (!supabase) {
                // Fallback to localStorage if Supabase not configured
                saveToLocalStorage();
                return;
            }
            
            try {
                // Clear existing events for this month/year
                await supabase
                    .from('calendar_events')
                    .delete()
                    .eq('month', currentMonth)
                    .eq('year', currentYear);
                
                // Collect all events
                const eventsToSave = [];
                document.querySelectorAll('.day-cell').forEach(cell => {
                    const dayNumber = parseInt(cell.querySelector('.day-number').textContent);
                    
                    cell.querySelectorAll('.event').forEach(event => {
                        const text = event.textContent.replace('×', '').trim();
                        const className = event.getAttribute('data-class');
                        const isTentative = event.classList.contains('tentative');
                        
                        eventsToSave.push({
                            year: currentYear,
                            month: currentMonth,
                            day: dayNumber,
                            event_text: text,
                            event_class: className,
                            is_tentative: isTentative,
                            created_at: new Date().toISOString()
                        });
                    });
                });
                
                // Insert new events
                if (eventsToSave.length > 0) {
                    const { error } = await supabase
                        .from('calendar_events')
                        .insert(eventsToSave);
                    
                    if (error) throw error;
                }
                
                console.log('Calendar saved to Supabase successfully');
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                // Fallback to localStorage
                saveToLocalStorage();
            }
        }
        
        async function loadCalendarData() {
            if (!supabase) {
                // Fallback to localStorage if Supabase not configured
                loadFromLocalStorage();
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('calendar_events')
                    .select('*')
                    .eq('month', currentMonth)
                    .eq('year', currentYear);
                
                if (error) throw error;
                
                // Clear existing events (except hardcoded ones)
                document.querySelectorAll('.event').forEach(event => {
                    if (!event.hasAttribute('data-hardcoded')) {
                        event.remove();
                    }
                });
                
                // Add events from database
                data.forEach(eventData => {
                    addEventToDOM(eventData.day, eventData.event_text, eventData.event_class, eventData.is_tentative);
                });
                
                console.log('Calendar loaded from Supabase successfully');
            } catch (error) {
                console.error('Error loading from Supabase:', error);
                // Fallback to localStorage
                loadFromLocalStorage();
            }
        }
        
        // Fallback localStorage functions
        function saveToLocalStorage() {
            const calendarData = {
                month: currentMonth,
                year: currentYear,
                events: {}
            };
            
            document.querySelectorAll('.day-cell').forEach(cell => {
                const dayNumber = cell.querySelector('.day-number').textContent;
                const events = [];
                
                cell.querySelectorAll('.event').forEach(event => {
                    if (!event.hasAttribute('data-hardcoded')) {
                        const text = event.textContent.replace('×', '').trim();
                        const className = event.getAttribute('data-class');
                        const isTentative = event.classList.contains('tentative');
                        
                        events.push({
                            text: text,
                            class: className,
                            tentative: isTentative
                        });
                    }
                });
                
                if (events.length > 0) {
                    calendarData.events[dayNumber] = events;
                }
            });
            
            localStorage.setItem('teachingCalendar', JSON.stringify(calendarData));
        }
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('teachingCalendar');
            if (saved) {
                const data = JSON.parse(saved);
                
                // Add events from localStorage
                Object.keys(data.events || {}).forEach(day => {
                    data.events[day].forEach(event => {
                        addEventToDOM(parseInt(day), event.text, event.class, event.tentative);
                    });
                });
            }
        }
        
        // Helper function to add event to DOM
        function addEventToDOM(day, text, className, isTentative = false) {
            const dayCells = document.querySelectorAll('.day-cell');
            let targetCell = null;
            
            dayCells.forEach(cell => {
                const dayNumber = parseInt(cell.querySelector('.day-number').textContent);
                if (dayNumber === day) {
                    targetCell = cell;
                }
            });
            
            if (targetCell) {
                const eventDiv = document.createElement('div');
                eventDiv.className = `event class-${className}`;
                eventDiv.setAttribute('data-class', className);
                if (isTentative) {
                    eventDiv.classList.add('tentative');
                }
                
                eventDiv.innerHTML = `
                    ${text}
                    <button class="delete-btn" onclick="deleteEvent(this)">&times;</button>
                `;
                
                targetCell.appendChild(eventDiv);
            }
        }
        
        // Export/Import functionality
        function exportCalendar() {
            saveCalendarData();
            const data = localStorage.getItem('teachingCalendar');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `teaching-calendar-${currentYear}-${currentMonth + 1}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importCalendar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            localStorage.setItem('teachingCalendar', e.target.result);
                            alert('Calendar imported successfully! Refresh the page to see changes.');
                        } catch (error) {
                            alert('Error importing calendar: Invalid file format');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                closeModal();
            }
        };
        
        // Add click handlers to existing day cells
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.day-cell').forEach((cell, index) => {
                if (!cell.onclick) {
                    const dayNumber = cell.querySelector('.day-number').textContent;
                    cell.onclick = () => addEvent(parseInt(dayNumber));
                }
            });
        });
    </script>
</body>
</html>
